---
auto_apply: true
apply_to: ["models/**/*.php", "migrations/**/*.php"]
---

# Правила работы с базой данных

## Миграции

- Создавать миграции для всех изменений структуры БД
- Использовать осмысленные имена для миграций
- Добавлять методы `up()` и `down()` для отката
- Использовать транзакции для критических изменений

## ActiveRecord запросы

- Использовать Query Builder для сложных запросов
- Избегать N+1 проблем с помощью `with()` и `joinWith()`
- Использовать индексы для оптимизации производительности
- Кэшировать часто используемые запросы

## Примеры оптимизированных запросов

```php
// Плохо - N+1 проблема
$products = Product::find()->all();
foreach ($products as $product) {
    echo $product->category->name; // Дополнительный запрос для каждого продукта
}

// Хорошо - один запрос с JOIN
$products = Product::find()->with('category')->all();
foreach ($products as $product) {
    echo $product->category->name; // Данные уже загружены
}
```

## Валидация данных

- Валидировать данные на уровне модели
- Использовать встроенные валидаторы Yii2
- Создавать кастомные валидаторы при необходимости
- Добавлять уникальные ограничения в БД

## Безопасность

- Никогда не использовать прямые SQL запросы с пользовательскими данными
- Использовать параметризованные запросы
- Экранировать все входные данные
- Использовать транзакции для атомарных операций
